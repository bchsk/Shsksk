<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة إدارة QR SaaS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info span {
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Main Container */
        .container {
            display: flex;
            min-height: calc(100vh - 72px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            border-left: 1px solid var(--border);
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
            border-right: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: var(--light);
            color: var(--primary);
        }

        .nav-item.active {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            border-right-color: var(--primary);
            font-weight: 500;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Content */
        .content {
            flex: 1;
            padding: 2rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card h3 {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .stat-change.positive {
            color: #28a745;
        }

        .stat-change.negative {
            color: #dc3545;
        }

        /* Tables */
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background-color: var(--light);
            padding: 1rem;
            text-align: right;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .table tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge-primary {
            background-color: #dbeafe;
            color: #1e40af;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Login Screen */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 2rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
        }

        .login-container h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary);
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-danger {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 500;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
                border-left: none;
                border-top: 1px solid var(--border);
            }
            
            .nav-list {
                display: flex;
                overflow-x: auto;
                padding: 0.5rem;
            }
            
            .nav-item {
                white-space: nowrap;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Search */
        .search-box {
            position: relative;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding-right: 40px;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .page-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            background: white;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        .page-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn:hover:not(.active) {
            background-color: var(--light);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2><i class="fas fa-lock"></i> تسجيل الدخول للإدارة</h2>
        <div class="form-group">
            <label class="form-label">البريد الإلكتروني</label>
            <input type="email" id="loginEmail" class="form-control" placeholder="admin@qr.com">
        </div>
        <div class="form-group">
            <label class="form-label">كلمة المرور</label>
            <input type="password" id="loginPassword" class="form-control" placeholder="admin123">
        </div>
        <button onclick="login()" class="btn btn-primary" style="width: 100%;">
            <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
        </button>
        <div id="loginError" class="alert alert-danger" style="display: none; margin-top: 1rem;"></div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" style="display: none;">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-qrcode"></i>
                <span id="systemName">إدارة QR SaaS</span>
            </h1>
            <div class="user-info">
                <span id="userName">المسؤول</span>
                <button onclick="logout()" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
        </div>

        <div class="container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="nav-list">
                    <a href="#" class="nav-item active" onclick="showSection('dashboardSection')">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>لوحة التحكم</span>
                    </a>
                    <a href="#" class="nav-item" onclick="showSection('usersSection')">
                        <i class="fas fa-users"></i>
                        <span>المستخدمين</span>
                    </a>
                    <a href="#" class="nav-item" onclick="showSection('qrcodesSection')">
                        <i class="fas fa-qrcode"></i>
                        <span>رموز QR</span>
                    </a>
                    <a href="#" class="nav-item" onclick="showSection('settingsSection')">
                        <i class="fas fa-cog"></i>
                        <span>الإعدادات</span>
                    </a>
                    <a href="#" class="nav-item" onclick="showSection('analyticsSection')">
                        <i class="fas fa-chart-bar"></i>
                        <span>التقارير</span>
                    </a>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>إجمالي المستخدمين</h3>
                            <div class="stat-value" id="totalUsers">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span id="newUsers">0 جديد</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي رموز QR</h3>
                            <div class="stat-value" id="totalQRs">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span id="todayQRs">0 اليوم</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3>المستخدمين النشطين</h3>
                            <div class="stat-value" id="activeUsers">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>نشطين اليوم</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3>نسبة الاستخدام</h3>
                            <div class="stat-value" id="usageRate">0%</div>
                            <div class="stat-change positive">
                                <i class="fas fa-chart-line"></i>
                                <span>من السعة</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-history"></i>
                                أحدث المستخدمين
                            </h3>
                            <button class="btn btn-sm btn-primary" onclick="loadUsers()">
                                <i class="fas fa-sync"></i> تحديث
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="table" id="recentUsersTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>الاسم</th>
                                        <th>البريد</th>
                                        <th>الدور</th>
                                        <th>حد QR</th>
                                        <th>المستخدم</th>
                                        <th>التسجيل</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                توزيع أنواع QR
                            </h3>
                        </div>
                        <div id="qrTypesChart" style="height: 300px; padding: 1rem;">
                            <div style="text-align: center; padding: 3rem;">
                                <i class="fas fa-chart-pie fa-3x" style="color: #dee2e6;"></i>
                                <p style="color: #6c757d; margin-top: 1rem;">سيظهر الرسم البياني هنا</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="usersSection" class="section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-users-cog"></i>
                                إدارة المستخدمين
                            </h3>
                            <div style="display: flex; gap: 1rem;">
                                <div class="search-box">
                                    <input type="text" id="userSearch" class="form-control" placeholder="بحث..." onkeyup="searchUsers()">
                                    <i class="fas fa-search"></i>
                                </div>
                                <button class="btn btn-primary" onclick="showAddUserModal()">
                                    <i class="fas fa-user-plus"></i> إضافة مستخدم
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>الاسم</th>
                                        <th>البريد</th>
                                        <th>الدور</th>
                                        <th>الحالة</th>
                                        <th>الحد</th>
                                        <th>المستخدم</th>
                                        <th>النشاط</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="usersPagination"></div>
                    </div>
                </div>

                <!-- QR Codes Section -->
                <div id="qrcodesSection" class="section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-qrcode"></i>
                                جميع رموز QR
                            </h3>
                            <div style="display: flex; gap: 1rem;">
                                <select id="qrTypeFilter" class="form-control" style="width: 150px;" onchange="loadQRCodes()">
                                    <option value="">جميع الأنواع</option>
                                    <option value="url">رابط</option>
                                    <option value="text">نص</option>
                                    <option value="wifi">واي فاي</option>
                                    <option value="vcard">بطاقة اتصال</option>
                                    <option value="email">بريد</option>
                                </select>
                                <div class="search-box">
                                    <input type="text" id="qrSearch" class="form-control" placeholder="بحث في المحتوى..." onkeyup="searchQR()">
                                    <i class="fas fa-search"></i>
                                </div>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table" id="qrTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>المستخدم</th>
                                        <th>النوع</th>
                                        <th>المحتوى</th>
                                        <th>الحجم</th>
                                        <th>التاريخ</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="qrPagination"></div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-cogs"></i>
                                إعدادات النظام
                            </h3>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">اسم النظام</label>
                                <input type="text" id="settingSystemName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">الحد الافتراضي للمستخدمين</label>
                                <input type="number" id="settingDefaultLimit" class="form-control" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">الحد اليومي للمستخدمين</label>
                                <input type="number" id="settingDailyLimit" class="form-control" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">التسجيل مفتوح</label>
                                <select id="settingAllowRegistration" class="form-control">
                                    <option value="true">نعم</option>
                                    <option value="false">لا</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save"></i> حفظ الإعدادات
                        </button>
                    </div>

                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-database"></i>
                                إدارة قاعدة البيانات
                            </h3>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-success" onclick="exportData('users')">
                                <i class="fas fa-file-export"></i> تصدير المستخدمين
                            </button>
                            <button class="btn btn-success" onclick="exportData('qrcodes')">
                                <i class="fas fa-file-export"></i> تصدير رموز QR
                            </button>
                            <button class="btn btn-warning" onclick="createBackup()">
                                <i class="fas fa-save"></i> نسخة احتياطية
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="analyticsSection" class="section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                تقارير وإحصائيات
                            </h3>
                            <select id="analyticsPeriod" class="form-control" style="width: 150px;" onchange="loadAnalytics()">
                                <option value="7days">آخر 7 أيام</option>
                                <option value="30days">آخر 30 يوم</option>
                                <option value="month">هذا الشهر</option>
                                <option value="year">هذه السنة</option>
                            </select>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>متوسط الرموز/يوم</h3>
                                <div class="stat-value" id="avgDailyQRs">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>أعلى مستخدم</h3>
                                <div class="stat-value" id="topUserQRs">0</div>
                                <div class="stat-change">
                                    <span id="topUserName">لا يوجد</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3>أكثر نوع استخداماً</h3>
                                <div class="stat-value" id="topQRType">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>معدل النمو</h3>
                                <div class="stat-value" id="growthRate">0%</div>
                            </div>
                        </div>

                        <div style="margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem;">نشاط إنشاء QR</h3>
                            <div id="activityChart" style="height: 300px; background: #f8f9fa; border-radius: 0.5rem; padding: 1rem;">
                                <div style="text-align: center; padding: 3rem;">
                                    <i class="fas fa-chart-line fa-3x" style="color: #dee2e6;"></i>
                                    <p style="color: #6c757d; margin-top: 1rem;">سيظهر الرسم البياني هنا</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> إضافة مستخدم جديد</h3>
                <button class="close-btn" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">الاسم الكامل</label>
                    <input type="text" id="newUserName" class="form-control" placeholder="أدخل الاسم">
                </div>
                <div class="form-group">
                    <label class="form-label">البريد الإلكتروني</label>
                    <input type="email" id="newUserEmail" class="form-control" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" id="newUserPassword" class="form-control" placeholder="كلمة مرور قوية">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">الدور</label>
                        <select id="newUserRole" class="form-control">
                            <option value="user">مستخدم</option>
                            <option value="admin">مسؤول</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">حد QR المسموح</label>
                        <input type="number" id="newUserLimit" class="form-control" value="10" min="1">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addUserModal')">إلغاء</button>
                <button class="btn btn-primary" onclick="addNewUser()">
                    <i class="fas fa-save"></i> حفظ
                </button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> تعديل المستخدم</h3>
                <button class="close-btn" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label class="form-label">الاسم الكامل</label>
                    <input type="text" id="editUserName" class="form-control">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">الدور</label>
                        <select id="editUserRole" class="form-control">
                            <option value="user">مستخدم</option>
                            <option value="admin">مسؤول</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">حد QR المسموح</label>
                        <input type="number" id="editUserLimit" class="form-control" min="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">الحالة</label>
                        <select id="editUserStatus" class="form-control">
                            <option value="active">نشط</option>
                            <option value="suspended">موقوف</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">خطة الاشتراك</label>
                        <select id="editUserPlan" class="form-control">
                            <option value="free">مجاني</option>
                            <option value="basic">أساسي</option>
                            <option value="premium">مميز</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('editUserModal')">إلغاء</button>
                <button class="btn btn-primary" onclick="saveUserChanges()">
                    <i class="fas fa-save"></i> حفظ التغييرات
                </button>
            </div>
        </div>
    </div>

    <!-- QR Preview Modal -->
    <div id="qrPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-qrcode"></i> معاينة QR</h3>
                <button class="close-btn" onclick="closeModal('qrPreviewModal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div id="qrPreviewImage" style="margin: 1rem 0;"></div>
                <p id="qrPreviewContent" style="word-break: break-all; background: #f8f9fa; padding: 1rem; border-radius: 0.375rem;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('qrPreviewModal')">إغلاق</button>
                <button class="btn btn-primary" onclick="downloadQRPreview()">
                    <i class="fas fa-download"></i> تحميل
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentToken = localStorage.getItem('adminToken');
        let currentUser = null;
        let currentPage = 'users';
        let currentQRPage = 1;
        let currentUsersPage = 1;
        let usersData = [];
        let qrData = [];

        // Check authentication on load
        if (currentToken) {
            checkAuth();
        }

        // ==================== AUTH FUNCTIONS ====================
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            errorDiv.style.display = 'none';

            if (!email || !password) {
                showError('الرجاء إدخال البريد وكلمة المرور');
                return;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.user.role !== 'admin') {
                        showError('هذه اللوحة للمسؤولين فقط!');
                        return;
                    }

                    currentToken = data.token;
                    currentUser = data.user;

                    localStorage.setItem('adminToken', currentToken);
                    showDashboard();
                    loadDashboard();
                } else {
                    showError(data.error || 'خطأ في تسجيل الدخول');
                }
            } catch (error) {
                showError('خطأ في الاتصال بالخادم');
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            currentToken = null;
            currentUser = null;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
        }

        async function checkAuth() {
            if (!currentToken) return false;

            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const userData = JSON.parse(atob(currentToken.split('.')[1]));
                    if (userData.role === 'admin') {
                        currentUser = userData;
                        showDashboard();
                        loadDashboard();
                        return true;
                    }
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }

            logout();
            return false;
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorDiv.style.display = 'block';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name || currentUser.email;
        }

        // ==================== DASHBOARD FUNCTIONS ====================
        async function loadDashboard() {
            if (!await checkAuth()) return;

            try {
                // Load system stats
                const statsRes = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (statsRes.ok) {
                    const stats = await statsRes.json();
                    updateStats(stats.stats);
                }

                // Load recent users
                await loadUsers();

                // Load system settings
                await loadSettings();

            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        function updateStats(stats) {
            document.getElementById('totalUsers').textContent = stats.total_users || 0;
            document.getElementById('totalQRs').textContent = stats.total_qrs || 0;
            document.getElementById('activeUsers').textContent = stats.active_users || 0;
            document.getElementById('todayQRs').textContent = stats.today_qrs ? `${stats.today_qrs} اليوم` : '0 اليوم';
            document.getElementById('newUsers').textContent = stats.today_users ? `${stats.today_users} جديد` : '0 جديد';
            
            // Calculate usage rate
            if (stats.total_qrs && stats.total_users) {
                const avg = Math.round(stats.total_qrs / stats.total_users);
                document.getElementById('usageRate').textContent = `${avg}%`;
            }
        }

        // ==================== USERS MANAGEMENT ====================
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    usersData = data.users;
                    displayUsers(usersData.slice(0, 10)); // Show first 10 users in dashboard
                    updateUsersTable(data.users);
                    updatePagination('users', data.pagination);
                }
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        function displayUsers(users) {
            const tbody = document.querySelector('#recentUsersTable tbody');
            tbody.innerHTML = '';

            users.forEach((user, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${user.name || 'بدون اسم'}</td>
                        <td>${user.email}</td>
                        <td>${getRoleBadge(user.role)}</td>
                        <td>${user.qr_limit}</td>
                        <td>
                            <span class="badge ${user.qr_used >= user.qr_limit ? 'badge-danger' : 'badge-success'}">
                                ${user.qr_used} / ${user.qr_limit}
                            </span>
                        </td>
                        <td>${formatDate(user.created_at)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateUsersTable(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            users.forEach((user, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${user.name || 'بدون اسم'}</td>
                        <td>${user.email}</td>
                        <td>${getRoleBadge(user.role)}</td>
                        <td>${getStatusBadge(user.status)}</td>
                        <td>${user.qr_limit}</td>
                        <td>
                            <span class="badge ${user.qr_used >= user.qr_limit ? 'badge-danger' : 'badge-success'}">
                                ${user.qr_used} / ${user.qr_limit}
                            </span>
                        </td>
                        <td>${user.last_login ? formatDate(user.last_login) : 'لم يسجل دخول'}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-sm btn-primary" onclick="editUser('${user.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}', '${user.email}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filteredUsers = usersData.filter(user => 
                user.email.toLowerCase().includes(searchTerm) ||
                (user.name && user.name.toLowerCase().includes(searchTerm))
            );
            updateUsersTable(filteredUsers);
        }

        // ==================== QR CODES MANAGEMENT ====================
        async function loadQRCodes() {
            try {
                const typeFilter = document.getElementById('qrTypeFilter').value;
                let url = '/api/admin/qrcodes';
                if (typeFilter) {
                    url += `?type=${typeFilter}`;
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    qrData = data.qr_codes;
                    updateQRTable(qrData);
                    updatePagination('qr', data.pagination);
                }
            } catch (error) {
                console.error('Failed to load QR codes:', error);
            }
        }

        function updateQRTable(qrCodes) {
            const tbody = document.querySelector('#qrTable tbody');
            tbody.innerHTML = '';

            qrCodes.forEach((qr, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${qr.user_name || qr.user_id}</td>
                        <td>${getQRTypeBadge(qr.type)}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                            ${qr.content.length > 50 ? qr.content.substring(0, 50) + '...' : qr.content}
                        </td>
                        <td>${qr.size}px</td>
                        <td>${formatDate(qr.created_at)}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-sm btn-primary" onclick="previewQR('${qr.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteQR('${qr.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function searchQR() {
            const searchTerm = document.getElementById('qrSearch').value.toLowerCase();
            const filteredQR = qrData.filter(qr => 
                qr.content.toLowerCase().includes(searchTerm) ||
                (qr.user_name && qr.user_name.toLowerCase().includes(searchTerm))
            );
            updateQRTable(filteredQR);
        }

        async function previewQR(qrId) {
            try {
                const response = await fetch(`/api/qr/${qrId}/download`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const qr = qrData.find(q => q.id === qrId);
                    
                    const reader = new FileReader();
                    reader.onload = function() {
                        document.getElementById('qrPreviewImage').innerHTML = `
                            <img src="${reader.result}" alt="QR Code" style="max-width: 200px; border-radius: 0.5rem;">
                        `;
                        document.getElementById('qrPreviewContent').textContent = qr.content;
                        
                        // Store QR ID for download
                        document.getElementById('qrPreviewImage').dataset.qrId = qrId;
                        
                        showModal('qrPreviewModal');
                    };
                    reader.readAsDataURL(blob);
                }
            } catch (error) {
                console.error('Failed to preview QR:', error);
                alert('فشل في تحميل QR');
            }
        }

        async function downloadQRPreview() {
            const qrId = document.getElementById('qrPreviewImage').dataset.qrId;
            if (qrId) {
                const link = document.createElement('a');
                link.href = `/api/qr/${qrId}/download`;
                link.download = `qr-${qrId}.png`;
                link.click();
                closeModal('qrPreviewModal');
            }
        }

        async function deleteQR(qrId) {
            if (!confirm('هل أنت متأكد من حذف هذا QR؟')) return;

            try {
                const response = await fetch(`/api/qr/${qrId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    alert('تم حذف QR بنجاح');
                    loadQRCodes();
                } else {
                    alert('فشل في حذف QR');
                }
            } catch (error) {
                console.error('Failed to delete QR:', error);
                alert('خطأ في الاتصال بالخادم');
            }
        }

        // ==================== USER MANAGEMENT MODALS ====================
        function showAddUserModal() {
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserRole').value = 'user';
            document.getElementById('newUserLimit').value = 10;
            showModal('addUserModal');
        }

        async function addNewUser() {
            const userData = {
                name: document.getElementById('newUserName').value,
                email: document.getElementById('newUserEmail').value,
                password: document.getElementById('newUserPassword').value,
                role: document.getElementById('newUserRole').value,
                qr_limit: parseInt(document.getElementById('newUserLimit').value)
            };

            if (!userData.name || !userData.email || !userData.password) {
                alert('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }

            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('تم إنشاء المستخدم بنجاح');
                    closeModal('addUserModal');
                    loadUsers();
                } else {
                    alert(data.error || 'فشل في إنشاء المستخدم');
                }
            } catch (error) {
                console.error('Failed to add user:', error);
                alert('خطأ في الاتصال بالخادم');
            }
        }

        async function editUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserLimit').value = user.qr_limit;
            document.getElementById('editUserStatus').value = user.status || 'active';
            document.getElementById('editUserPlan').value = user.subscription_plan || 'free';

            showModal('editUserModal');
        }

        async function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const userData = {
                name: document.getElementById('editUserName').value,
                role: document.getElementById('editUserRole').value,
                qr_limit: parseInt(document.getElementById('editUserLimit').value),
                status: document.getElementById('editUserStatus').value,
                subscription_plan: document.getElementById('editUserPlan').value
            };

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    alert('تم تحديث المستخدم بنجاح');
                    closeModal('editUserModal');
                    loadUsers();
                } else {
                    alert('فشل في تحديث المستخدم');
                }
            } catch (error) {
                console.error('Failed to update user:', error);
                alert('خطأ في الاتصال بالخادم');
            }
        }

        async function deleteUser(userId, userEmail) {
            if (!confirm(`هل أنت متأكد من حذف المستخدم ${userEmail}؟\nسيتم حذف جميع رموز QR الخاصة به.`)) return;

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    alert('تم حذف المستخدم بنجاح');
                    loadUsers();
                } else {
                    alert('فشل في حذف المستخدم');
                }
            } catch (error) {
                console.error('Failed to delete user:', error);
                alert('خطأ في الاتصال بالخادم');
            }
        }

        // ==================== SETTINGS ====================
        async function loadSettings() {
            try {
                const response = await fetch('/api/admin/settings', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const settings = data.settings;

                    if (settings.system_name) {
                        document.getElementById('systemName').textContent = settings.system_name;
                        document.getElementById('settingSystemName').value = settings.system_name;
                    }
                    if (settings.default_qr_limit) {
                        document.getElementById('settingDefaultLimit').value = settings.default_qr_limit;
                    }
                    if (settings.daily_qr_limit) {
                        document.getElementById('settingDailyLimit').value = settings.daily_qr_limit;
                    }
                    if (settings.allow_registration) {
                        document.getElementById('settingAllowRegistration').value = settings.allow_registration;
                    }
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        async function saveSettings() {
            const settings = {
                system_name: document.getElementById('settingSystemName').value,
                default_qr_limit: document.getElementById('settingDefaultLimit').value,
                daily_qr_limit: document.getElementById('settingDailyLimit').value,
                allow_registration: document.getElementById('settingAllowRegistration').value
            };

            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('تم حفظ الإعدادات بنجاح');
                    loadSettings();
                } else {
                    alert('فشل في حفظ الإعدادات');
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                alert('خطأ في الاتصال بالخادم');
            }
        }

        // ==================== ANALYTICS ====================
        async function loadAnalytics() {
            // Implement analytics loading
            console.log('Loading analytics...');
        }

        // ==================== EXPORT & BACKUP ====================
        async function exportData(type) {
            try {
                let url = '/api/admin/export/users';
                let filename = 'users-export.csv';

                if (type === 'qrcodes') {
                    // You'll need to implement this endpoint in backend
                    url = '/api/admin/export/qrcodes';
                    filename = 'qrcodes-export.csv';
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                } else {
                    alert('فشل في تصدير البيانات');
                }
            } catch (error) {
                console.error('Export failed:', error);
                alert('خطأ في تصدير البيانات');
            }
        }

        async function createBackup() {
            try {
                const response = await fetch('/api/admin/backup', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    alert('تم إنشاء نسخة احتياطية بنجاح');
                } else {
                    alert('فشل في إنشاء النسخة الاحتياطية');
                }
            } catch (error) {
                console.error('Backup failed:', error);
                alert('خطأ في إنشاء النسخة الاحتياطية');
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            document.getElementById(sectionId).style.display = 'block';

            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const navMap = {
                'dashboardSection': 0,
                'usersSection': 1,
                'qrcodesSection': 2,
                'settingsSection': 3,
                'analyticsSection': 4
            };
            
            document.querySelectorAll('.nav-item')[navMap[sectionId]]?.classList.add('active');

            // Load data for the section
            switch(sectionId) {
                case 'usersSection':
                    loadUsers();
                    break;
                case 'qrcodesSection':
                    loadQRCodes();
                    break;
                case 'settingsSection':
                    loadSettings();
                    break;
                case 'analyticsSection':
                    loadAnalytics();
                    break;
            }
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA') + ' ' + date.toLocaleTimeString('ar-SA');
        }

        function getRoleBadge(role) {
            if (role === 'admin') {
                return '<span class="badge badge-primary">مسؤول</span>';
            }
            return '<span class="badge badge-success">مستخدم</span>';
        }

        function getStatusBadge(status) {
            if (status === 'active') {
                return '<span class="badge badge-success">نشط</span>';
            } else if (status === 'suspended') {
                return '<span class="badge badge-danger">موقوف</span>';
            }
            return '<span class="badge badge-warning">غير معروف</span>';
        }

        function getQRTypeBadge(type) {
            const typeNames = {
                'url': 'رابط',
                'text': 'نص',
                'wifi': 'واي فاي',
                'vcard': 'بطاقة',
                'email': 'بريد',
                'sms': 'رسالة',
                'whatsapp': 'واتساب',
                'location': 'موقع'
            };
            
            const badgeColors = {
                'url': 'primary',
                'text': 'success',
                'wifi': 'warning',
                'vcard': 'danger',
                'email': 'primary',
                'sms': 'success',
                'whatsapp': 'success',
                'location': 'warning'
            };
            
            const name = typeNames[type] || type;
            const color = badgeColors[type] || 'secondary';
            
            return `<span class="badge badge-${color}">${name}</span>`;
        }

        function updatePagination(type, pagination) {
            const container = document.getElementById(`${type}Pagination`);
            if (!container || !pagination) return;

            container.innerHTML = '';

            const totalPages = pagination.pages || 1;
            const currentPage = pagination.page || 1;

            // Previous button
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'page-btn';
                prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                prevBtn.onclick = () => changePage(type, currentPage - 1);
                container.appendChild(prevBtn);
            }

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => changePage(type, i);
                container.appendChild(pageBtn);
            }

            // Next button
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-btn';
                nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                nextBtn.onclick = () => changePage(type, currentPage + 1);
                container.appendChild(nextBtn);
            }
        }

        function changePage(type, page) {
            if (type === 'users') {
                currentUsersPage = page;
                loadUsers();
            } else if (type === 'qr') {
                currentQRPage = page;
                loadQRCodes();
            }
        }

        // Initialize
        if (currentToken) {
            checkAuth();
        }
    </script>
</body>
</html>
